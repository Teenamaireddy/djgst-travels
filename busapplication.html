<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DJGST Travels | AI Premium Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{ --primary:#D84E55; --dark:#0f172a; --bg:#F1F5F9; --gold:#fbbf24; }
body{ margin:0; font-family:'Plus Jakarta Sans',sans-serif; background:#f1f5f9; color:#334155; overflow-x: hidden; }

/* SIDEBAR */
aside{ width:260px; background:var(--dark); color:white; padding:30px; position:fixed; height:100vh; z-index:10; box-sizing:border-box; }
.nav-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; display:flex; align-items:center; gap:10px; }
.nav-active { background: var(--primary) !important; }

main{ margin-left:260px; padding:30px; min-height:100vh; }

@media(max-width:768px){
    aside{width:100%;height:auto;padding:15px;position:relative;display:flex;flex-direction:column;}
    main{margin-left:0;padding:15px;}
}

/* CARDS */
.card{ background:white; padding:25px; border-radius:24px; margin-bottom:20px; box-shadow:0 10px 25px rgba(0,0,0,.05); }
input, select{ width:100%; padding:14px; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:12px; box-sizing: border-box; font-family: inherit; }
.btn-action{ background:var(--primary); color:white; border:none; padding:16px; border-radius:14px; cursor:pointer; width:100%; font-weight:700; transition: 0.3s; }
.btn-action:hover{ opacity: 0.9; transform: scale(0.98); }

/* SEAT SELECTION STYLES */
.bus-layout { background: #f8fafc; padding: 20px; border-radius: 20px; border: 2px solid #e2e8f0; max-width: 280px; margin: 0 auto 20px; }
.seats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.seat { height: 40px; background: #e2e8f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transition: 0.2s; }
.seat.selected { background: var(--primary); color: white; transform: scale(1.1); }
.seat.occupied { background: #cbd5e1; cursor: not-allowed; opacity: 0.4; }
.aisle { grid-column: 3; pointer-events: none; background: transparent; }

/* PAYMENT APP STYLES */
.pay-options { display: flex; justify-content: center; gap: 12px; margin: 15px 0; flex-wrap: wrap; }
.pay-tool { border: 2px solid #f1f5f9; padding: 8px; border-radius: 12px; cursor: pointer; width: 55px; transition: 0.3s; background: white; }
.pay-tool.active { border-color: var(--primary); background: #fff1f2; transform: translateY(-3px); }
.pay-tool img { width: 100%; height: auto; border-radius: 4px; }

/* SURPRISE ENVELOPE STYLES */
#surprise-wrap { display:none; text-align:center; padding:40px 0; perspective: 1000px; }
.envelope { width: 220px; height: 150px; background: #c2410c; margin: 0 auto; position: relative; cursor: pointer; border-radius: 0 0 10px 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.5s; }
.envelope:hover { transform: translateY(-10px) rotate(2deg); }
.envelope-flap { position: absolute; top: 0; left: 0; border-left: 110px solid transparent; border-right: 110px solid transparent; border-top: 90px solid #ea580c; transform-origin: top; transition: all 0.4s; z-index: 2; }
.envelope-glow { position: absolute; inset: 0; background: radial-gradient(circle, var(--gold) 0%, transparent 70%); opacity: 0; animation: pulseGlow 2s infinite; }
@keyframes pulseGlow { 0% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 0.2; transform: scale(0.8); } }
.envelope-text { color: white; position: absolute; bottom: 15px; width: 100%; font-weight: 800; font-size: 14px; letter-spacing: 1px; }

/* RESTORED ANIMATIONS */
.falling-item { position: absolute; top: -10%; animation: fall linear infinite; z-index: 1; pointer-events: none; }
@keyframes fall { to { transform: translateY(600px); } }

.sun-container { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); z-index: 1; pointer-events: none; }
.sun-core { width: 120px; height: 120px; background: radial-gradient(circle, #fff 10%, #ffdb4d 40%, transparent 70%); border-radius: 50%; box-shadow: 0 0 100px #fbbf24; animation: sunPulse 4s infinite alternate ease-in-out; }
@keyframes sunPulse { from { transform: scale(1); opacity: 0.9; } to { transform: scale(1.4); opacity: 1; } }

.desert-bg-animate { animation: bgShift 4s infinite alternate ease-in-out; }
@keyframes bgShift { from { background-color: #0ea5e9; } to { background-color: #ffdb4d; } }

.desert-sand { position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: linear-gradient(to bottom, #edc9af, #d2a679); border-top-left-radius: 60% 30px; border-top-right-radius: 40% 20px; z-index: 2; }
.desert-plant { position: absolute; bottom: 85px; font-size: 45px; z-index: 3; filter: drop-shadow(2px 5px 10px rgba(0,0,0,0.3)); animation: plantSway 3s infinite ease-in-out; transform-origin: bottom; }
@keyframes plantSway { 0%, 100% { transform: rotate(-2deg); } 50% { transform: rotate(2deg); } }

.laughing-hill-box { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); text-align: center; animation: hillBounce 0.7s infinite alternate ease-in-out; z-index: 2; }
.hill-face { font-size: 115px; position: relative; display: inline-block; }
.hill-eyes { position: absolute; top: 52px; left: 50%; transform: translateX(-50%); font-size: 24px; display: flex; gap: 20px; }
.hill-smile { position: absolute; top: 75px; left: 50%; transform: translateX(-50%); font-size: 34px; }
@keyframes hillBounce { from { transform: translate(-50%, 0); } to { transform: translate(-50%, -20px); } }

.ritual-bell { position: absolute; top: -10px; font-size: 40px; animation: bellSwing 2s infinite ease-in-out; transform-origin: top; z-index: 6; }
@keyframes bellSwing { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } }
.floating-diya { position: absolute; bottom: 20px; font-size: 30px; animation: diyaGlow 1.5s infinite alternate; filter: drop-shadow(0 0 10px orange); }
@keyframes diyaGlow { from { opacity: 0.6; transform: translateY(0); } to { opacity: 1; transform: translateY(-5px); } }

.ocean { height: 150px; width: 100%; position: absolute; bottom: 0; left: 0; background: #01579b; opacity: 0.6; z-index: 1; overflow: hidden; }
.wave { background: url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/85486/wave.svg) repeat-x; position: absolute; top: -55px; width: 6400px; height: 198px; animation: wave 7s linear infinite; }
@keyframes wave { 0% { margin-left: 0; } 100% { margin-left: -1600px; } }
.surfer { position: absolute; bottom: 40px; left: -100px; font-size: 40px; z-index: 4; animation: surfMove 10s linear infinite; }
@keyframes surfMove {
    0% { left: -50px; transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-10px) rotate(5deg); }
    50% { transform: translateY(0) rotate(-5deg); }
    75% { transform: translateY(-10px) rotate(5deg); }
    100% { left: 400px; transform: translateY(0) rotate(0deg); }
}

/* GREETING */
#greeting-card-container { display:none; width:350px; height:550px; margin:30px auto; border-radius:24px; position:relative; overflow:hidden; color:white; box-shadow:0 25px 50px rgba(0,0,0,0.2); text-align: center; }
.greet-overlay { position:absolute; inset:0; padding:30px; display:flex; flex-direction:column; justify-content:space-between; z-index:5; background: rgba(0,0,0,0.1); }

/* RECEIPT */
#formal-receipt { display:none; max-width:420px; margin:20px auto; background: white; padding:30px; border-radius:15px; border: 1px solid #e2e8f0; color: #1e293b; text-align:left; }

/* AI */
#ai-assistant{ position:fixed; bottom:20px; right:20px; width:330px; z-index:999; }
#ai-header{ background:var(--dark); color:white; padding:15px; border-radius:15px 15px 0 0; cursor:pointer; display:flex; justify-content:space-between; }
#ai-body{ background:white; border-radius:0 0 15px 15px; display:none; flex-direction:column; height:400px; border:1px solid #eee; }
#ai-messages{ flex:1; padding:15px; overflow-y:auto; font-size:13px; display:flex; flex-direction:column; gap:10px; }
.ai-msg{ padding:12px; border-radius:15px; max-width:85%; }
.ai-user{ background:#f1f5f9; align-self:flex-end; }
.ai-bot{ background:var(--dark); color:white; align-self:flex-start; }
#ai-input-area{ display:flex; padding:10px; border-top:1px solid #eee; }
#ai-input{ border:none; padding:10px; outline:none; background:#f8fafc; border-radius:8px; flex:1; }

#loader{ position:fixed; inset:0; background:rgba(255,255,255,.9); z-index:2000; display:none; flex-direction:column; align-items:center; justify-content:center; }
</style>
</head>
<body>

<div id="loader">
    <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_1pxqjqps.json" background="transparent" speed="1" style="width: 250px; height: 250px;" loop autoplay></lottie-player>
    <p>Processing Your Booking...</p>
</div>

<aside>
    <h1>DJGST Travels</h1>
    <div class="nav-links">
        <div class="nav-item nav-active" id="nav-book" onclick="showTab('booking')"><i class="fa fa-bus"></i> <span id="txt-book">Book Ticket</span></div>
        <div class="nav-item" id="nav-trips" onclick="showTab('trips')"><i class="fa fa-suitcase"></i> <span id="txt-trips">My Trips</span></div>
        <select id="lang-select" onchange="translatePage()" style="margin-top:10px; background:#1e293b; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer;">
            <option value="en">English</option>
            <option value="te">Telugu</option>
            <option value="hi">Hindi</option>
        </select>
    </div>
</aside>

<main>
    <div id="tab-booking">
        <div id="search-card" class="card">
            <h3 id="txt-plan"><i class="fa-solid fa-bus"></i> Plan Your Journey</h3>
            <input id="u-name" placeholder="Passenger Name">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <input id="u-src" placeholder="From City">
                <input id="u-dest" placeholder="To City">
            </div>
            <select id="u-bus-type">
                <option value="Premium Sleeper" data-price="1200">Premium Sleeper (‚Çπ1200)</option>
                <option value="Luxury AC Sleeper" data-price="1500">Luxury AC Sleeper (‚Çπ1500)</option>
            </select>
            <input type="date" id="u-date-input">
            <button class="btn-action" onclick="showSeatSelection()" id="txt-btn-search">Search & Select Seat</button>
        </div>

        <div id="seat-card" class="card" style="display:none; text-align:center;">
            <h3><i class="fa fa-chair"></i> Select Your Seat</h3>
            <div class="bus-layout">
                <div style="margin-bottom:12px; font-weight:bold; color:#94a3b8; font-size:12px;">FRONT / DRIVER SIDE</div>
                <div class="seats-grid" id="seats-grid"></div>
            </div>
            <p id="seat-selection-txt" style="font-weight:600; color:var(--primary); margin-bottom:15px;">Selected Seat: None</p>
            <button class="btn-action" onclick="goToPayment()">Confirm Seat & Pay</button>
        </div>

        <div id="payment-card" class="card" style="display:none; text-align:center">
            <h3 id="txt-pay-title">Payment Secure</h3>
            <p id="pay-summary"></p>
            
            <div class="pay-options">
                <div class="pay-tool" onclick="selectPayApp('Paytm', this)"><img src="https://img.icons8.com/color/48/paytm.png"/></div>
                <div class="pay-tool" onclick="selectPayApp('PhonePe', this)"><img src="https://img.icons8.com/color/48/phonepe.png"/></div>
                <div class="pay-tool" onclick="selectPayApp('GooglePay', this)"><img src="https://img.icons8.com/color/48/google-pay.png"/></div>
            </div>

            <div style="background:#f8fafc;padding:20px;border-radius:15px;margin:10px auto; width:180px;">
                <img id="qr-display" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=DJGST_PAY" style="width:100%">
                <p style="font-size:10px; color:#64748b; margin-top:8px;" id="qr-label">Scan to pay via UPI</p>
            </div>
            
            <div style="margin:15px 0;">
                <p style="font-size:12px; font-weight:bold; color:#64748b;">OR Pay via Mobile Number</p>
                <input id="u-mobile-pay" placeholder="Enter Mobile Number / UPI ID" style="text-align:center;">
            </div>

            <button class="btn-action" onclick="showEmotionSelector()">Confirm & Select Vibe</button>
        </div>

        <div id="emotion-screen" class="card" style="display:none">
            <h3 id="txt-emo-title">Choose Journey Vibe</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="btn-action" style="background:#f59e0b" onclick="selectEmotion('pilgrimage')">ü™î Pilgrimage</button>
                <button class="btn-action" style="background:#0ea5e9" onclick="selectEmotion('vacation')">üèñÔ∏è Vacation</button>
                <button class="btn-action" style="background:#334155" onclick="selectEmotion('business')">üíº Business</button>
                <button class="btn-action" style="background:#ec4899" onclick="selectEmotion('special')">‚ù§Ô∏è Special</button>
            </div>
        </div>

        <div id="surprise-wrap" class="card" style="border: 2px dashed #e2e8f0;">
            <h2 style="margin-top:0; color:#c2410c">üéâ Booking Confirmed!</h2>
            <p>We have a special surprise package for you. Tap to open!</p>
            <div class="envelope" onclick="openEnvelope()" onmouseover="playBeep()">
                <div class="envelope-glow"></div>
                <div class="envelope-flap" id="env-flap"></div>
                <div class="envelope-text">OPEN SURPRISE</div>
            </div>
        </div>

        <div id="greeting-card-container">
            <div id="env-container"></div>
            <div class="greet-overlay">
                <div>
                    <h1 id="greet-logo" style="text-shadow: 2px 2px 10px rgba(0,0,0,0.5)"></h1>
                    <p id="greet-dest-text" style="font-size:20px; font-weight:bold"></p>
                </div>
                <div>
                    <h2>Bon Voyage!</h2>
                    <p id="greet-main-msg"></p>
                    <button class="btn-action" onclick="saveAndFinish()" style="background:white; color:var(--dark); border-radius:30px">Complete Booking</button>
                </div>
            </div>
        </div>

        <div id="formal-receipt">
            <div style="text-align:center; border-bottom: 2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h2 style="color:var(--primary); margin:0">TRAVEL INVOICE</h2>
                <small id="rec-tid"></small>
            </div>
            <p><strong>Passenger Name:</strong> <span id="rec-name"></span></p>
            <p><strong>Seat:</strong> <span id="rec-seat"></span></p>
            <p><strong>Travel Date:</strong> <span id="rec-date"></span></p>
            <p><strong>Route:</strong> <span id="rec-route"></span></p>
            <p><strong>Service:</strong> <span id="rec-class"></span></p>
            <div style="text-align:center; margin-top:20px;">
                <img id="rec-qr" style="width:100px; border:1px solid #eee; padding:5px">
                <button class="btn-action" onclick="downloadReceipt()" style="margin-top:15px; background:#64748b">üì• Save Receipt Image</button>
            </div>
        </div>
    </div>

    <div id="tab-trips" style="display:none;">
        <div class="card">
            <h3 id="txt-history">My Trip History</h3>
            <div id="trips-list">No bookings found yet.</div>
        </div>
    </div>
</main>

<div id="ai-assistant">
    <div id="ai-header" onclick="toggleAI()"><span>ü§ñ Book with AI</span><i class="fa fa-message"></i></div>
    <div id="ai-body">
        <div id="ai-messages"></div>
        <div id="ai-input-area">
            <input id="ai-input" placeholder="Type your response...">
            <button onclick="handleAI()" style="background:var(--primary);color:white;border:none;padding:10px;border-radius:8px">‚û§</button>
        </div>
    </div>
</div>

<script>
let bookingData = { name:'', src:'', dest:'', date:'', busType:'', price:'', emotion:'', tid:'', seat:'' };
let aiStep = 0; 

const tadaAudio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3'); 
const hoverAudio = new Audio('https://www.soundjay.com/buttons/sounds/button-37.mp3');
hoverAudio.volume = 0.2;

const langData = {
    en: { book: "Book Ticket", trips: "My Trips", plan: "Plan Your Journey", pay: "Payment", emo: "Journey Vibe", hist: "Trip History" },
    te: { book: "‡∞ü‡∞ø‡∞ï‡±Ü‡∞ü‡±ç ‡∞¨‡±Å‡∞ï‡±ç", trips: "‡∞®‡∞æ ‡∞™‡±ç‡∞∞‡∞Ø‡∞æ‡∞£‡∞æ‡∞≤‡±Å", plan: "‡∞™‡±ç‡∞≤‡∞æ‡∞®‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø", pay: "‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡∞ø‡∞Ç‡∞™‡±Å", emo: "‡∞™‡±ç‡∞∞‡∞Ø‡∞æ‡∞£ ‡∞∞‡∞ï‡∞Ç", hist: "‡∞™‡±ç‡∞∞‡∞Ø‡∞æ‡∞£ ‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞" },
    hi: { book: "‡§ü‡§ø‡§ï‡§ü ‡§¨‡•Å‡§ï", trips: "‡§Æ‡•á‡§∞‡•Ä ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ‡§è‡§Ç", plan: "‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¨‡§®‡§æ‡§è‡§Ç", pay: "‡§≠‡•Å‡§ó‡§§‡§æ‡§®", emo: "‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞", hist: "‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏" }
};

window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('u-date-input').setAttribute('min', today);
    loadHistory();
    initSeatMap();
    setTimeout(() => { toggleAI(); addChat("Welcome to DJGST! Let's get started. What is your **Name**?", "bot"); }, 1000);
};

function playBeep() { hoverAudio.play(); }

function toggleAI() { 
    let b = document.getElementById("ai-body"); 
    b.style.display = (b.style.display === "flex") ? "none" : "flex"; 
}

function handleAI() {
    const inp = document.getElementById("ai-input");
    const val = inp.value.trim();
    if(!val) return;
    addChat(val, "user");
    inp.value = "";
    setTimeout(() => {
        if(aiStep === 0) {
            bookingData.name = val; document.getElementById("u-name").value = val;
            addChat(`Hello **${val}**! Now tell me your route. (Example: **Delhi to Goa**)`, "bot"); aiStep = 1;
        } 
        else if(aiStep === 1) {
            if(val.toLowerCase().includes(" to ")) {
                const p = val.toLowerCase().split(" to ");
                document.getElementById("u-src").value = p[0].trim();
                document.getElementById("u-dest").value = p[1].trim();
                bookingData.src = p[0].trim(); bookingData.dest = p[1].trim();
                addChat("Route updated! When are you traveling? (**YYYY-MM-DD**)", "bot"); aiStep = 2;
            } else { addChat("Please say 'Source to Destination'.", "bot"); }
        }
        else if(aiStep === 2) {
            const match = val.match(/\d{4}-\d{2}-\d{2}/);
            if(match) {
                document.getElementById("u-date-input").value = match[0]; bookingData.date = match[0];
                addChat("Got it! Click **Search & Select Seat**.", "bot"); aiStep = 3;
            } else { addChat("Use format 2026-05-20.", "bot"); }
        }
    }, 600);
}

function addChat(t, type) {
    const d = document.createElement("div"); d.className = `ai-msg ai-${type}`; d.innerHTML = t;
    const msgBox = document.getElementById("ai-messages");
    msgBox.appendChild(d); msgBox.scrollTop = msgBox.scrollHeight;
}

// SEAT SELECTION LOGIC
function initSeatMap() {
    const grid = document.getElementById('seats-grid');
    grid.innerHTML = "";
    for(let i=1; i<=20; i++) {
        const s = document.createElement('div');
        s.className = 'seat';
        if(Math.random() < 0.2) s.classList.add('occupied');
        s.innerText = i;
        s.onclick = () => selectSeat(s, i);
        grid.appendChild(s);
    }
}

function selectSeat(el, num) {
    if(el.classList.contains('occupied')) return;
    document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
    el.classList.add('selected');
    bookingData.seat = num;
    document.getElementById('seat-selection-txt').innerText = "Selected Seat: " + num;
}

function showSeatSelection() {
    if(!document.getElementById("u-name").value || !document.getElementById("u-src").value) return alert("Fill all fields first!");
    document.getElementById("search-card").style.display = "none";
    document.getElementById("seat-card").style.display = "block";
}

function selectPayApp(app, el) {
    document.querySelectorAll('.pay-tool').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('qr-label').innerText = "Scan to pay via " + app;
    document.getElementById('qr-display').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=DJGST_PAY_${app}`;
}

function goToPayment() {
    if(!bookingData.seat) return alert("Please select a seat first!");
    bookingData.name = document.getElementById("u-name").value;
    bookingData.src = document.getElementById("u-src").value;
    bookingData.dest = document.getElementById("u-dest").value;
    bookingData.date = document.getElementById("u-date-input").value;
    let b = document.getElementById("u-bus-type");
    bookingData.busType = b.value;
    bookingData.price = b.options[b.selectedIndex].getAttribute('data-price');
    bookingData.tid = "DJGST-" + Math.floor(100000 + Math.random() * 900000);

    document.getElementById("loader").style.display="flex";
    setTimeout(()=>{
        document.getElementById("loader").style.display="none";
        document.getElementById("seat-card").style.display="none";
        document.getElementById("pay-summary").innerText = `${bookingData.busType} | Seat: ${bookingData.seat} | ‚Çπ${bookingData.price}`;
        document.getElementById("payment-card").style.display="block";
    },1000);
}

function showEmotionSelector() {
    document.getElementById("payment-card").style.display="none";
    document.getElementById("emotion-screen").style.display="block";
}

function selectEmotion(emo) {
    bookingData.emotion = emo;
    document.getElementById("emotion-screen").style.display="none";
    document.getElementById("surprise-wrap").style.display = "block";
    confetti({ particleCount: 40, origin: { y: 0.8 } });
}

function openEnvelope() {
    tadaAudio.play();
    document.getElementById("env-flap").style.transform = "rotateX(180deg)";
    document.getElementById("env-flap").style.zIndex = "0";
    setTimeout(() => {
        document.getElementById("surprise-wrap").style.display = "none";
        renderResults();
    }, 700);
}

function renderResults() {
    const themes = {
        pilgrimage: { color: "#f59e0b", logo: "DIVINE DJGST", msg: "Have a blessed journey." },
        vacation: { color: "#0ea5e9", logo: "DJGST ESCAPE", msg: "Time for some fun!" },
        business: { color: "#334155", logo: "DJGST ELITE", msg: "Wising you success." },
        special: { color: "#ec4899", logo: "DJGST MAGIC", msg: "Enjoy every moment." }
    };
    const t = themes[bookingData.emotion];
    const dest = bookingData.dest.toLowerCase();
    const container = document.getElementById("env-container");
    const cardContainer = document.getElementById("greeting-card-container");
    container.innerHTML = "";

    cardContainer.style.display = "block";
    cardContainer.style.background = t.color;
    document.getElementById("greet-logo").innerText = t.logo;
    document.getElementById("greet-dest-text").innerText = `${bookingData.src} ‚ûî ${bookingData.dest}`;
    document.getElementById("greet-main-msg").innerText = t.msg;

    cardContainer.classList.remove('desert-bg-animate');

    if (bookingData.emotion === 'pilgrimage' || dest.includes('tirupati') || dest.includes('shirdi')) {
        container.innerHTML += `<div class="ritual-bell" style="left:20px">üîî</div><div class="ritual-bell" style="right:20px">üîî</div><div class="floating-diya" style="left:50px">ü™î</div><div class="floating-diya" style="right:50px">ü™î</div>`;
        for(let i=0; i<15; i++) {
            let s = document.createElement('div'); s.className = 'falling-item'; s.innerHTML = 'üå∏';
            s.style.left = Math.random()*100+'%'; s.style.animationDuration = (Math.random()*3+3)+'s';
            container.appendChild(s);
        }
    }
    if (dest.includes('goa') || dest.includes('vizag') || dest.includes('beach')) {
        container.innerHTML += `<div class="ocean"><div class="surfer">üèÑ‚Äç‚ôÄÔ∏è</div><div class="wave"></div><div class="wave"></div></div>`;
    }
    if (dest.includes('ooty') || dest.includes('hill') || dest.includes('shimla')) {
        container.innerHTML += `<div class="laughing-hill-box"><div class="hill-face">‚õ∞Ô∏è<div class="hill-eyes">üëÄ</div><div class="hill-smile">üòä</div></div></div>`;
        for(let i=0; i<30; i++) {
            let s = document.createElement('div'); s.className = 'falling-item'; s.innerHTML = '‚ùÑÔ∏è';
            s.style.left = Math.random()*100+'%'; s.style.animationDuration = (Math.random()*3+2)+'s';
            container.appendChild(s);
        }
    } 
    if (dest.includes('jaipur') || dest.includes('desert') || dest.includes('rajasthan')) {
        cardContainer.classList.add('desert-bg-animate');
        container.innerHTML += `<div class="desert-sand"></div><div class="desert-plant" style="left:15%">üåµ</div><div class="desert-plant" style="right:20%; font-size:32px; bottom:75px">üåµ</div>`;
        let sun = document.createElement("div"); sun.className = "sun-container"; sun.innerHTML = `<div class="sun-core"></div>`; container.appendChild(sun);
    }

    document.getElementById("formal-receipt").style.display = "block";
    document.getElementById("rec-name").innerText = bookingData.name;
    document.getElementById("rec-seat").innerText = bookingData.seat;
    document.getElementById("rec-date").innerText = bookingData.date;
    document.getElementById("rec-route").innerText = `${bookingData.src} to ${bookingData.dest}`;
    document.getElementById("rec-class").innerText = bookingData.busType;
    document.getElementById("rec-tid").innerText = "ID: " + bookingData.tid;
    document.getElementById("rec-qr").src = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${bookingData.tid}`;
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
}

function saveAndFinish() {
    let list = JSON.parse(localStorage.getItem('djgst_trips') || '[]');
    list.push({...bookingData});
    localStorage.setItem('djgst_trips', JSON.stringify(list));
    alert("Trip saved!");
    location.reload();
}

function loadHistory() {
    const saved = localStorage.getItem('djgst_trips');
    if(saved) {
        const trips = JSON.parse(saved);
        document.getElementById("trips-list").innerHTML = trips.map(t => `<div class="card" style="padding:10px; border-left: 5px solid var(--primary)">${t.date}: ${t.src} to ${t.dest} (Seat ${t.seat})</div>`).join('');
    }
}
function downloadReceipt() {
    html2canvas(document.getElementById("formal-receipt")).then(c => {
        const a = document.createElement("a"); a.href = c.toDataURL(); a.download = `DJGST_${bookingData.tid}.png`; a.click();
    });
}
function translatePage() {
    const l = document.getElementById("lang-select").value;
    document.getElementById("txt-book").innerText = langData[l].book;
    document.getElementById("txt-trips").innerText = langData[l].trips;
    document.getElementById("txt-plan").innerText = langData[l].plan;
    document.getElementById("txt-pay-title").innerText = langData[l].pay;
    document.getElementById("txt-emo-title").innerText = langData[l].emo;
    document.getElementById("txt-history").innerText = langData[l].hist;
}
function showTab(tab) {
    document.getElementById("tab-booking").style.display = tab === 'booking' ? 'block' : 'none';
    document.getElementById("tab-trips").style.display = tab === 'trips' ? 'block' : 'none';
    document.getElementById("nav-book").classList.toggle('nav-active', tab === 'booking');
    document.getElementById("nav-trips").classList.toggle('nav-active', tab === 'trips');
}
</script>
</body>
</html>
